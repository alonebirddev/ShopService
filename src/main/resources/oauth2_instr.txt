Build and Run
mvn clean install -DskipTests spring-boot:run
Usage
Checking app is deployed sucessfullly
curl -i http://localhost:9191/api/hello
Hello User!
Access secure resource with token
curl -i http://localhost:9191/api/secure

{"timestamp":1444985908768,"status":401,"error":"Unauthorized","message":"Access Denied","path":"/api/secure"}
Fetching refresh_token
curl -vu rajithapp:secret 'http://localhost:9191/api/oauth/token?username=admin&password=admin&grant_type=password'

{"access_token":"91202244-431f-444a-b053-7f50716f2012","token_type":"bearer","refresh_token":"e6f8624f-213d-4343-a971-980e83f734be","expires_in":1738,"scope":"read write"}
Fetching acess_token by submitting refresh_token
curl -vu rajithapp:secret 'http://localhost:9191/api/oauth/token?grant_type=refresh_token&refresh_token=<refresh_token>'

{"access_token":"821c99d4-2c9f-4990-b68d-18eacaff54b2","token_type":"bearer","refresh_token":"e6f8624f-213d-4343-a971-980e83f734be","expires_in":1799,"scope":"read write"}
Access secure resource sucessfully
curl -i -H "Authorization: Bearer <access_token>" http://localhost:9191/api/secure

Secure Hello!


INSERT INTO ouath2_user (username,email, password, activated) VALUES ('admin', 'admin@mail.me', 'b8f57d6d6ec0a60dfe2e20182d4615b12e321cad9e2979e0b9f81e0d6eda78ad9b6dcfe53e4e22d1', true);
INSERT INTO ouath2_user (username,email, password, activated) VALUES ('user', 'user@mail.me', 'd6dfa9ff45e03b161e7f680f35d90d5ef51d243c2a8285aa7e11247bc2c92acde0c2bb626b1fac74', true);
INSERT INTO oauth2_user (username,email, password, activated) VALUES ('rajith', 'rajith@abc.com', 'd6dfa9ff45e03b161e7f680f35d90d5ef51d243c2a8285aa7e11247bc2c92acde0c2bb626b1fac74', true);

INSERT INTO ouath2_authority (name) VALUES ('ROLE_USER');
INSERT INTO oauth2_authority (name) VALUES ('ROLE_ADMIN');

INSERT INTO oauth2_user_authority (username,authority) VALUES ('rajith', 'ROLE_USER');
INSERT INTO oauth2_user_authority (username,authority) VALUES ('user', 'ROLE_USER');
INSERT INTO oauth2_user_authority (username,authority) VALUES ('admin', 'ROLE_USER');
INSERT INTO oauth2_user_authority (username,authority) VALUES ('admin', 'ROLE_ADMIN');


CREATE TABLE oauth2_user (
  username VARCHAR(50) NOT NULL PRIMARY KEY,
  email VARCHAR(50),
  password VARCHAR(500),
  activated BOOLEAN DEFAULT FALSE,
  activationkey VARCHAR(50) DEFAULT NULL,
  resetpasswordkey VARCHAR(50) DEFAULT NULL
 );

 CREATE TABLE oauth2_authority (
  name VARCHAR(50) NOT NULL PRIMARY KEY
 );
 CREATE TABLE oauth2_user_authority (
   username VARCHAR(50) NOT NULL,
   authority VARCHAR(50) NOT NULL,
   FOREIGN KEY (username) REFERENCES oauth2_user (username),
   FOREIGN KEY (authority) REFERENCES oauth2_authority (name)
 );

 create unique index user_authority_idx_1 on oauth2_user_authority using btree (username, authority);

 CREATE TABLE oauth_access_token (
  token_id VARCHAR(256) DEFAULT NULL,
  token BYTEA,
  authentication_id VARCHAR(256) DEFAULT NULL,
  user_name VARCHAR(256) DEFAULT NULL,
  client_id VARCHAR(256) DEFAULT NULL,
  authentication BYTEA,
  refresh_token VARCHAR(256) DEFAULT NULL
 );
 CREATE TABLE oauth_refresh_token (
  token_id VARCHAR(256) DEFAULT NULL,
  token BYTEA,
  authentication BYTEA
 );
 
 ---------------------------------------------------------------------------------------
 select * from jpa_bmb_user;
delete from  jpa_bmb_user;

update jpa_bmb_user
set user_name = 'rajith' 
where bmb_user_id = 6;


drop table oauth_refresh_token cascade;














CREATE TABLE oauth2_authority (
  name VARCHAR(50) NOT NULL PRIMARY KEY
 );
 CREATE TABLE oauth2_user_authority (
   auth_id bigint NOT NULL,
   username VARCHAR(50) NOT NULL,
   authority VARCHAR(50) NOT NULL,
   FOREIGN KEY (auth_id) REFERENCES jpa_bmb_user (bmb_user_id),
   FOREIGN KEY (authority) REFERENCES oauth2_authority (name)
 );

 create unique index user_authority_idx_1 on oauth2_user_authority using btree (username, authority);

 CREATE TABLE oauth_access_token (
  token_id VARCHAR(256) DEFAULT NULL,
  token BYTEA,
  authentication_id VARCHAR(256) DEFAULT NULL,
  user_name VARCHAR(256) DEFAULT NULL,
  client_id VARCHAR(256) DEFAULT NULL,
  authentication BYTEA,
  refresh_token VARCHAR(256) DEFAULT NULL
 );
 CREATE TABLE oauth_refresh_token (
  token_id VARCHAR(256) DEFAULT NULL,
  token BYTEA,
  authentication BYTEA
 );

INSERT INTO oauth2_authority (name) VALUES ('ROLE_USER');
INSERT INTO oauth2_authority (name) VALUES ('ROLE_ADMIN');

INSERT INTO oauth2_user_authority (auth_id,username,authority) VALUES (6,'rajith', 'ROLE_USER');
INSERT INTO oauth2_user_authority (auth_id,username,authority) VALUES (1,'user', 'ROLE_USER');
INSERT INTO oauth2_user_authority (auth_id,username,authority) VALUES (2,'admin', 'ROLE_USER');
INSERT INTO oauth2_user_authority (auth_id,username,authority) VALUES (3,'admin', 'ROLE_ADMIN');

------------------------------------------------------------------------------------------------------------
select * from jpa_bmb_user;

alter table oauth2_user_authority drop constraint  fkg0j39yschovqh0jibc2o8a12l;
drop table oauth2_user_authority ;
drop table oauth_access_token;
drop table oauth_refresh_token;
drop table oauth2_authority;
drop table oauth2_user;


CREATE TABLE oauth2_user (
  username VARCHAR(50) NOT NULL PRIMARY KEY,
  email VARCHAR(50),
  password VARCHAR(500),
  activated BOOLEAN DEFAULT FALSE,
  activationkey VARCHAR(50) DEFAULT NULL,
  resetpasswordkey VARCHAR(50) DEFAULT NULL
 );

 CREATE TABLE oauth2_authority (
  name VARCHAR(50) NOT NULL PRIMARY KEY
 );
 CREATE TABLE oauth2_user_authority (
 bmb_user_id BIGINT NOT NULL,
   username VARCHAR(50) NOT NULL,
   authority VARCHAR(50) NOT NULL,
   FOREIGN KEY (bmb_user_id) REFERENCES jpa_bmb_user (bmb_user_id),
   FOREIGN KEY (authority) REFERENCES oauth2_authority (name)
 );

 create unique index user_authority_idx_1 on oauth2_user_authority using btree (bmb_user_id, username, authority);

 CREATE TABLE oauth_access_token (
  token_id VARCHAR(256) DEFAULT NULL,
  token BYTEA,
  authentication_id VARCHAR(256) DEFAULT NULL,
  bmb_user_id BIGINT DEFAULT 0,
  client_id VARCHAR(256) DEFAULT NULL,
  authentication BYTEA,
  refresh_token VARCHAR(256) DEFAULT NULL
 );
 CREATE TABLE oauth_refresh_token (
  token_id VARCHAR(256) DEFAULT NULL,
  token BYTEA,
  authentication BYTEA
 );
 
 INSERT INTO oauth2_authority (name) VALUES ('ROLE_USER');
INSERT INTO oauth2_authority (name) VALUES ('ROLE_ADMIN');

update jpa_bmb_user
set user_name = 'admin'
where bmb_user_id = 11;

delete from jpa_bmb_user where bmb_user_id = 7;
delete from oauth2_user_authority where bmb_user_id = 7;

INSERT INTO oauth2_user_authority (bmb_user_id,authority) VALUES (11, 'ROLE_ADMIN');
INSERT INTO oauth2_authority (name) VALUES ('ROLE_ADMIN');

INSERT INTO oauth2_user_authority (bmb_user_id,authority) VALUES (3,'admin', 'ROLE_ADMIN');

 CREATE TABLE oauth_access_token (
  token_id VARCHAR(256) DEFAULT NULL,
  token BYTEA,
  authentication_id VARCHAR(256) DEFAULT NULL,
  user_name VARCHAR(256) DEFAULT NULL,
  client_id VARCHAR(256) DEFAULT NULL,
  authentication BYTEA,
  refresh_token VARCHAR(256) DEFAULT NULL
 );
 CREATE TABLE oauth_refresh_token (
  token_id VARCHAR(256) DEFAULT NULL,
  token BYTEA,
  authentication BYTEA
 );
------------------------------------------------------- 12/12
drop table oauth2_user_authority cascade;
drop table oauth_access_token cascade;
drop table oauth_refresh_token cascade;
drop table oauth2_authority cascade;
drop table oauth2_user cascade;

ALTER TABLE jpa_bmb_user
ADD CONSTRAINT username_uniq UNIQUE (user_name);
INSERT INTO oauth2_user_authority (username,authority) VALUES ('admin', 'ROLE_ADMIN');

ALTER TABLE "jpa_bmb_user" RENAME COLUMN "user_name" TO "username";
ALTER TABLE "jpa_bmb_user" drop COLUMN "username";
select * from jpa_bmb_user;

drop table shop_contacts;
drop table shop_opening_hours;
drop table shop_services;
drop table shop_shop_contact;
drop table shop_shop_services;

INSERT INTO shop_oauth2_authority (name) VALUES ('ROLE_USER');
INSERT INTO shop_oauth2_authority (name) VALUES ('ROLE_ADMIN');


 CREATE TABLE shop_oauth2_user_authority (
 bmb_user_id BIGINT NOT NULL,
   username VARCHAR(50) NOT NULL,
   authority VARCHAR(50) NOT NULL,
   FOREIGN KEY (bmb_user_id) REFERENCES shop_bmb_user (bmb_user_id),
   FOREIGN KEY (authority) REFERENCES shop_oauth2_authority (name)
 );


 